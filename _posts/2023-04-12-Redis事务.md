---
layout: post
title: Redis事务
subtitle: Redis学习笔记之事务
date: 2023-04-12 19:50:00 +0800
categories: Redis
author: 月梦
cover: 'https://s1.ax1x.com/2023/09/04/pPr9a7D.jpg'
cover_author: 'Mahdi Yusuf'
cover_author_link: 'https://architecturenotes.co/author/myusuf3/'
tags: 
- Redis  
---

## Redis事务定义
Redis事务是一个单独的隔离操作：事务中的所有命令都会序列化、按顺序地执行。事务在执行的过程中，不会被其他客户端发送来的命令请求所打断。  
Redis事务的主要作用就是串联多个命令防止别的命令插队。

## 基本命令
Multi、Exec、discard  
从输入Multi命令开始，输入的命令都会依次进入命令队列中，但不会执行，直到输入Exec后，Redis会将之前的命令队列中的命令依次执行。  
组队的过程中可以通过discard来放弃组队。  

## 事务的错误处理
组队中某个命令出现了报告错误，执行时整个的所有队列都会被取消。  
如果执行阶段某个命令报出了错误，则只有报错的命令不会被执行，而其他的命令都会执行，不会回滚。  

## 事务冲突问题
### 例子
三个人持有同一账户，总金额只有10000，一个请求想给金额减8000、一个请求想给金额减5000、一个请求想给金额减1000.  
由于最初判断时候账户里都是有10000，因此进入购买阶段，就导致买完之后总金额成负值，这肯定是不行的。  
Redis中针对事务冲突问题，有两种解决方式，如下。

### 悲观锁
在操作的时候对事务上锁，操作完成再释放锁。  
但是效率低。  

### 乐观锁
给变量加版本号，有人修改时，先比较他拿到的数据的版本号和数据库中的版本号是否一致，如果一致则可以操作，并修改数据版本号，如果不一致则不能操作。  

### 乐观锁在Redis中如何去使用？
在执行multi之前，先执行watch key1 [key2]，可以监视一个（或多个）key，如果在事务执行之前这个（或这些）key被其他命令所改动，那么事务将被打断。  
unwatch取消WATCH命令对所有key的监视。  

## Redis事务的三个特性
- 单独的隔离操作：事务中的所有命令都会被序列化，按顺序执行，事务在执行过程中，不会被其他客户端发送来的命令请求所打断。  
- 没有隔离级别的概念：队列中的命令没有提交之前都不会实际被执行  
- 不保证原子性：事务中如果有一条命令执行失败，其后的命令仍然会被执行，没有回滚。  

